<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define" xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form">
  <f:entry title="${it.name}" description="${it.description}">
    <div name="parameter">
      <input type="hidden" name="name" value="${it.name}" />
      <j:set var="choices" value="${it.choices}" />

      <j:choose>
        <j:when test="${!choices.isEmpty() and !choices.get(0).startsWith('Error:') and !choices.get(0).startsWith('Project not found:')}">
          <!-- Normal case: show branch choices -->
          <select name="value" class="jenkins-input">
            <j:forEach var="branch" items="${choices}">
              <option value="${branch}">
                <j:choose>
                  <j:when test="${branch.startsWith('tags/')}">
                    <j:out value="🏷️ ${branch}"/>
                  </j:when>
                  <j:otherwise>
                    <j:out value="🌿 ${branch}"/>
                  </j:otherwise>
                </j:choose>
              </option>
            </j:forEach>
          </select>
          
          <!-- Show configuration info -->
          <div style="margin-top: 8px; font-size: 12px; color: #666;">
            <strong>Project:</strong> ${it.projectId}
            <j:if test="${!empty(it.branchFilter)}">
              | <strong>Filter:</strong> ${it.branchFilter}
            </j:if>
            <j:if test="${it.includeTags}">
              | <strong>Includes tags</strong>
            </j:if>
          </div>
        </j:when>
        <j:otherwise>
          <!-- Error case: show disabled input with error message -->
          <select name="value" class="jenkins-input" disabled="true">
            <option value="">
              <j:out value="${choices.get(0)}"/>
            </option>
          </select>
          <div class="jenkins-alert jenkins-alert-danger" style="margin-top: 8px;">
            <p><strong>Unable to load branches</strong></p>
            <p><j:out value="${choices.get(0)}"/></p>
            <j:if test="${choices.get(0).startsWith('Project not found:')}">
              <p>Check that the Ansible project <code>${it.projectId}</code> exists in the global configuration.</p>
            </j:if>
            <j:if test="${choices.get(0).startsWith('Error:')}">
              <p>This might be due to network connectivity, credentials, or repository configuration issues.</p>
            </j:if>
          </div>
        </j:otherwise>
      </j:choose>
    </div>
  </f:entry>
</j:jelly>