<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define" 
         xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form">
  
  <l:layout title="Environment ACL Manager" permission="${app.ADMINISTER}">
    <l:header />

    <l:main-panel>
      <h1>Environment ACL Manager</h1>
      <p>Current configuration imported from Configuration as Code (JCasC)</p>
      
      <j:set var="config" value="${it.configuration}" />
      
      <!-- Environment Groups Section -->
      <f:section title="Environment Groups">
        <j:choose>
          <j:when test="${!config.environmentGroups.isEmpty()}">
            <table class="jenkins-table sortable">
              <thead>
                <tr>
                  <th>Group Name</th>
                  <th>Description</th>
                  <th>Environments</th>
                  <th>SSH Credential</th>
                  <th>Vault Credentials</th>
                </tr>
              </thead>
              <tbody>
                <j:forEach var="group" items="${config.environmentGroups}">
                  <tr>
                    <td><strong>${group.name}</strong></td>
                    <td>${group.description}</td>
                    <td>
                      <j:forEach var="env" items="${group.environments}" varStatus="envLoop">
                        <span class="jenkins-label">${env}</span>
                        <j:if test="${!envLoop.last}">, </j:if>
                      </j:forEach>
                    </td>
                    <td>
                      <j:choose>
                        <j:when test="${group.sshCredentialId != null}">
                          <code>${group.sshCredentialId}</code>
                        </j:when>
                        <j:otherwise>
                          <em>None</em>
                        </j:otherwise>
                      </j:choose>
                    </td>
                    <td>
                      <j:choose>
                        <j:when test="${!group.vaultCredentials.isEmpty()}">
                          <j:forEach var="vault" items="${group.vaultCredentials}" varStatus="vaultLoop">
                            <div style="margin-bottom: 2px;">
                              <strong>${vault.vaultId}:</strong> <code>${vault.credentialId}</code>
                              <j:if test="${vault.description != null}">
                                <br/><small style="color: #666;">${vault.description}</small>
                              </j:if>
                            </div>
                          </j:forEach>
                        </j:when>
                        <j:otherwise>
                          <em>None</em>
                        </j:otherwise>
                      </j:choose>
                    </td>
                  </tr>
                </j:forEach>
              </tbody>
            </table>
          </j:when>
          <j:otherwise>
            <div class="jenkins-alert jenkins-alert-info">
              <p>No environment groups configured. Add them via Configuration as Code (JCasC).</p>
            </div>
          </j:otherwise>
        </j:choose>
      </f:section>
      
      <!-- ACL Rules Section -->
      <f:section title="Access Control Rules">
        <j:choose>
          <j:when test="${!config.aclRules.isEmpty()}">
            <table class="jenkins-table sortable">
              <thead>
                <tr>
                  <th>Rule Name</th>
                  <th>Type</th>
                  <th>Priority</th>
                  <th>Jobs</th>
                  <th>Environments</th>
                  <th>Environment Groups</th>
                  <th>Users</th>
                  <th>Groups</th>
                </tr>
              </thead>
              <tbody>
                <j:forEach var="rule" items="${config.aclRules}">
                  <tr>
                    <td><strong>${rule.name}</strong></td>
                    <td>
                      <j:choose>
                        <j:when test="${rule.type == 'allow'}">
                          <span class="jenkins-label jenkins-label-success">✓ Allow</span>
                        </j:when>
                        <j:otherwise>
                          <span class="jenkins-label jenkins-label-error">✗ Deny</span>
                        </j:otherwise>
                      </j:choose>
                    </td>
                    <td>${rule.priority}</td>
                    <td>
                      <j:choose>
                        <j:when test="${!rule.jobs.isEmpty()}">
                          <j:forEach var="job" items="${rule.jobs}" varStatus="jobLoop">
                            <code>${job}</code><j:if test="${!jobLoop.last}">, </j:if>
                          </j:forEach>
                        </j:when>
                        <j:otherwise><em>None</em></j:otherwise>
                      </j:choose>
                    </td>
                    <td>
                      <j:choose>
                        <j:when test="${!rule.environments.isEmpty()}">
                          <j:forEach var="env" items="${rule.environments}" varStatus="envLoop">
                            <span class="jenkins-label">${env}</span><j:if test="${!envLoop.last}">, </j:if>
                          </j:forEach>
                        </j:when>
                        <j:otherwise><em>None</em></j:otherwise>
                      </j:choose>
                    </td>
                    <td>
                      <j:choose>
                        <j:when test="${!rule.environmentGroups.isEmpty()}">
                          <j:forEach var="envGroup" items="${rule.environmentGroups}" varStatus="groupLoop">
                            <span class="jenkins-label">${envGroup}</span><j:if test="${!groupLoop.last}">, </j:if>
                          </j:forEach>
                        </j:when>
                        <j:otherwise><em>None</em></j:otherwise>
                      </j:choose>
                    </td>
                    <td>
                      <j:choose>
                        <j:when test="${!rule.users.isEmpty()}">
                          <j:forEach var="user" items="${rule.users}" varStatus="userLoop">
                            <code>${user}</code><j:if test="${!userLoop.last}">, </j:if>
                          </j:forEach>
                        </j:when>
                        <j:otherwise><em>None</em></j:otherwise>
                      </j:choose>
                    </td>
                    <td>
                      <j:choose>
                        <j:when test="${!rule.groups.isEmpty()}">
                          <j:forEach var="group" items="${rule.groups}" varStatus="groupLoop">
                            <code>${group}</code><j:if test="${!groupLoop.last}">, </j:if>
                          </j:forEach>
                        </j:when>
                        <j:otherwise><em>None</em></j:otherwise>
                      </j:choose>
                    </td>
                  </tr>
                </j:forEach>
              </tbody>
            </table>
          </j:when>
          <j:otherwise>
            <div class="jenkins-alert jenkins-alert-info">
              <p>No ACL rules configured. Add them via Configuration as Code (JCasC).</p>
            </div>
          </j:otherwise>
        </j:choose>
      </f:section>
      
    </l:main-panel>
  </l:layout>
  
</j:jelly>